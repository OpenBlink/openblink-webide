<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenBlink WebIDE</title>
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/editor.css" />
    <link rel="stylesheet" href="css/console.css" />
    <link rel="stylesheet" href="css/history.css" />
    <link rel="stylesheet" href="codemirror/codemirror.css" />
    <link rel="stylesheet" href="codemirror/theme/dracula.css" />
  </head>
  <body>
    <h1>OpenBlink WebIDE</h1>
    <p class="description">
      OpenBlink WebIDE is a tool for writing Ruby code and transferring it to OpenBlink devices.
    </p>

    <div id="compatibility-warning"></div>

    <div class="main-container">
      <div class="left-panel">
        <div class="step">
          <div class="step-title">Step 1: Connect to Device</div>
          <div class="step-description">
            Click the "Connect to device" button and select an OpenBlink device from the Bluetooth device selection dialog.
          </div>
          <div class="button-group">
            <button id="ble-connect">Connect to device</button>
            <button id="ble-disconnect" class="secondary" disabled>Disconnect</button>
            <span id="connectionStatus" class="connection-status disconnected">Disconnected</span>
          </div>
        </div>

        <hr />

        <div class="step">
          <div class="step-title">Step 2: Write Ruby Code</div>
          <div class="step-description">
            Write your Ruby code in the editor below. You can use the sample code as a reference to create your own programs.
          </div>
          <div class="editor-container">
            <div class="editor-toolbar">
              <div class="form-group">
                <label for="board-selector">Board:</label>
                <select id="board-selector">
                  <option value="m5stamps3">M5 Stamp S3</option>
                </select>
              </div>
              <div class="editor-actions">
                <button id="load-file" class="secondary">Load .rb File</button>
                <div class="filename-input-group">
                  <input type="text" id="filename-input" value="program.rb" placeholder="filename.rb" />
                  <button id="save-file" class="secondary">Download</button>
                </div>
              </div>
            </div>
            <textarea id="ruby-code"></textarea>
          </div>
        </div>

        <hr />

        <div class="step">
          <div class="step-title">Step 3: Build and Transfer</div>
          <div class="step-description">
            Click the "Build & Blink" button to compile your code and transfer it to the device.
            Once the transfer is complete, the program will run automatically.
            Use the "Soft RESET" button to reset the device.
          </div>
          <div class="button-group">
            <button id="run-main" class="success" disabled>Build & Blink</button>
            <div class="form-group">
              <label for="slot-selector">Slot:</label>
              <select id="slot-selector">
                <option value="1">Slot 1</option>
                <option value="2" selected>Slot 2</option>
              </select>
            </div>
            <button id="soft-reset" class="danger" disabled>Soft RESET</button>
          </div>
        </div>

        <hr />

        <div class="console-container">
          <div class="console-header">
            <span class="console-title">Console Output</span>
            <button id="clear-console" class="clear-console-btn">Clear</button>
          </div>
          <div id="consoleOutput"></div>
        </div>
      </div>

      <div class="right-panel">
        <div id="metrics-panel">
          <div class="metrics-title">Performance Metrics</div>
          <div class="metrics-section">
            <div class="metrics-row">
              <div class="metrics-header">
                <span class="metrics-label">Compile Time</span>
                <span class="metrics-current" id="compile-current">--</span>
              </div>
              <div class="metrics-chart" id="compile-chart"></div>
            </div>
            <div class="metrics-row">
              <div class="metrics-header">
                <span class="metrics-label">Transfer Time</span>
                <span class="metrics-current" id="transfer-current">--</span>
              </div>
              <div class="metrics-chart" id="transfer-chart"></div>
            </div>
            <div class="metrics-row">
              <div class="metrics-header">
                <span class="metrics-label">Program Size</span>
                <span class="metrics-current" id="size-current">--</span>
              </div>
              <div class="metrics-chart" id="size-chart"></div>
            </div>
          </div>
        </div>

        <div id="history-panel">
          <div class="history-empty">No build history yet</div>
        </div>

        <div id="reference-panel">
          <div class="reference-title">Function Reference</div>
          <div id="reference-content">
            <h3>LED Control</h3>
            <ul>
              <li><code>LED.set([255, 0, 0])</code> - Set built-in LED to red</li>
              <li><code>LED.set([0, 255, 0])</code> - Set built-in LED to green</li>
              <li><code>LED.set([0, 0, 255])</code> - Set built-in LED to blue</li>
            </ul>
            <h3>Timer</h3>
            <ul>
              <li><code>sleep(seconds)</code> - Wait for specified seconds</li>
              <li><code>sleep_ms(milliseconds)</code> - Wait for specified milliseconds</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <hr />
    <div class="footer">
      <a href="https://github.com/OpenBlink">GitHub</a> |
      <a href="https://openblink.org">OpenBlink.org</a>
    </div>

    <script src="codemirror/codemirror.js"></script>
    <script src="codemirror/mode/ruby/ruby.js"></script>
    <script src="codemirror/addon/edit/matchbrackets.js"></script>
    <script>
      var editor = CodeMirror.fromTextArea(document.getElementById("ruby-code"), {
        mode: "ruby",
        theme: "dracula",
        lineNumbers: true,
        matchBrackets: true,
        autoCloseBrackets: true,
      });
      window.editor = editor;

      document.getElementById('clear-console').addEventListener('click', function() {
        document.getElementById('consoleOutput').innerHTML = '';
      });
    </script>
    <script>
      var Module = Module || {};
      Module.print = function(text) {
        var consoleOutput = document.getElementById("consoleOutput");
        if (consoleOutput && text && text.trim() !== "") {
          var line = document.createElement("div");
          line.textContent = text;
          consoleOutput.appendChild(line);
          consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
      };
      Module.printErr = function(text) {
        var consoleOutput = document.getElementById("consoleOutput");
        if (consoleOutput && text && text.trim() !== "") {
          var line = document.createElement("div");
          line.textContent = 'Compiler Error: ' + text;
          consoleOutput.appendChild(line);
          consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
      };
    </script>
    <script src="mrbc/mrbc.js"></script>
    <script src="lib/crc.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/ui-manager.js"></script>
    <script src="js/ble-protocol.js"></script>
    <script src="js/file-manager.js"></script>
    <script src="js/history-manager.js"></script>
    <script src="js/board-manager.js"></script>
    <script src="js/compiler.js"></script>
    <script src="js/main.js"></script>
  </body>
</html>
